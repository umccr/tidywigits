---
title: "BAMTOOLS"
lightbox:
  match: auto
  effect: fade
  desc-position: right
execute:
  echo: false
html-table-processing: none
---


```{r}
#| label: pkg_load
#| warning: false
#| message: false
{
  use("dplyr")
  use("tibble", "tibble")
  # box_path <- system.file("website/boxbox", package = "tidywigits")
  box_path <- here::here("inst/website/boxbox")
  options(box.path = box_path)
  box::use(
    wigits/utils[get_data, unnest_data_multi],
    wigits/table[reactable_wrapdown],
    bt_utils = bamtools/utils
  )
}
```

```{r}
#| label: data_setup
dat <- get_data()
dat$data <- dat$data |>
  dplyr::filter(grepl("bamtools", .data$tool_parser))
```

## Summary

```{r}
#| label: bamtools_summary
#| column: page
tbl_nm <- "bamtools_summary"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "summary", tb = "tbl1")
d2 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "covx", tbl = "tbl2")
descr1 <- tibble::tibble(field = "prefix", description = "File prefix") |>
  dplyr::bind_rows(d1$schema$schema[c("field", "description")])
d1$res |>
  reactable_wrapdown(
    descriptions = descr1,
    id = paste0(tbl_nm, "_summary"),
    pagination = TRUE
  )
d2$res |>
  ggplot2::ggplot(ggplot2::aes(x = covx, y = value, colour = prefix)) +
  ggplot2::geom_line() +
  ggplot2::theme_minimal()
```

## Coverage

```{r}
#| label: bamtools_coverage
#| column: page
tbl_nm <- "bamtools_coverage"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "coverage")
d1$res |>
  ggplot2::ggplot(ggplot2::aes(x = coverage, y = count, colour = prefix)) +
  ggplot2::geom_line() +
  # ggplot2::geom_point() +
  ggplot2::scale_y_continuous(labels = scales::comma) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    axis.text.y = ggplot2::element_text(angle = 60, hjust = 1)
  )
```

## Coverage Exon

```{r}
#| label: bamtools_exoncvg
#| column: page
tbl_nm <- "bamtools_exoncvg"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "exoncvg")
p1 <- d1$res |>
  ggplot2::ggplot(ggplot2::aes(x = gene, y = dp_med, fill = prefix)) +
  ggplot2::geom_point(alpha = 1 / 2, shape = 21, colour = "black") +
  ggplot2::theme(
    legend.position = "top",
    axis.text.y = ggplot2::element_text(angle = 45, hjust = 1, size = 6)
  ) +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge = 5)) +
  ggplot2::coord_flip()
```

```{r}
#| label: cvg_exon_scatter_plot1
#| fig-width: 10
#| fig-height: 25
p1
```

```{r}
#| label: cvg_exon_plot_bar
bt_utils$cvg_exon_plot_bar(d1$res)
```

```{r}
#| label: cvg_exon_plot_scatter
bt_utils$cvg_exon_plot_scatter(d1$res)
```

::: {.callout-tip}
## TODO

:::
