---
title: "BAMTOOLS"
lightbox:
  match: auto
  effect: fade
  desc-position: right
execute:
  echo: false
html-table-processing: none
---


```{r}
#| label: pkg_load
#| warning: false
#| message: false
{
  use("dplyr")
  use("tibble", "tibble")
  # box_path <- system.file("website/boxbox", package = "tidywigits")
  box_path <- here::here("inst/website/boxbox")
  options(box.path = box_path)
  box::use(
    wigits/utils[get_data, unnest_data_multi],
    wigits/table[reactable_wrapdown],
    bamtools/utils[cvg_exon_summary]
  )
}
```

```{r}
#| label: data_setup
dat <- get_data()
dat$data <- dat$data |>
  dplyr::filter(grepl("bamtools", .data$tool_parser))
```

## Summary

```{r}
#| label: bamtools_summary
#| column: page
tbl_nm <- "bamtools_summary"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "summary", tb = "tbl1")
d2 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "covx", tbl = "tbl2")
descr1 <- tibble::tibble(field = "prefix", description = "File prefix") |>
  dplyr::bind_rows(d1$schema$schema[c("field", "description")])
d1$res |>
  reactable_wrapdown(
    descriptions = descr1,
    id = paste0(tbl_nm, "_summary"),
    pagination = TRUE
  )
d2$res |>
  ggplot2::ggplot(ggplot2::aes(x = covx, y = value, colour = prefix)) +
  ggplot2::geom_line() +
  ggplot2::theme_minimal()
```

## Coverage

```{r}
#| label: bamtools_coverage
#| column: page
tbl_nm <- "bamtools_coverage"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "coverage")
d1$res |>
  ggplot2::ggplot(ggplot2::aes(x = coverage, y = count, colour = prefix)) +
  ggplot2::geom_line() +
  ggplot2::theme_minimal()
```

## Coverage Exon

```{r}
#| label: bamtools_exoncvg
#| column: page
tbl_nm <- "bamtools_exoncvg"
d1 <- dat$data |>
  unnest_data_multi(tbl_nm, schemas_all = dat$schemas, subnest = "exoncvg")
p1 <- d1$res |>
  ggplot2::ggplot(ggplot2::aes(x = gene, y = dp_med, fill = prefix)) +
  ggplot2::geom_point(alpha = 1 / 2, shape = 21, colour = "black") +
  ggplot2::theme(
    legend.position = "top",
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1, size = 5)
  ) +
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge = 5)) +
  ggplot2::coord_flip()
thresholds <- c(1, 5, 10, 20, 30, 50, 100)
sry_all <- purrr::map(thresholds, ~ cvg_exon_summary(d1$res, threshold = .x)) |>
  dplyr::bind_rows()
bar_data <- sry_all |>
  dplyr::filter(.data$n_below > 0) |> # Only show genes with issues
  dplyr::arrange(.data$threshold, desc(.data$n_below))
bar_fig <- plotly::plot_ly()
for (i in seq_along(thresholds)) {
  thresh <- thresholds[i]
  plot_data <- bar_data |> dplyr::filter(.data$threshold == thresh)
  bar_fig <- bar_fig |>
    plotly::add_bars(
      data = plot_data,
      x = ~ stats::reorder(gene, -n_below),
      y = ~n_below,
      name = paste("Threshold:", thresh),
      visible = (i == 3),
      text = ~ paste0(
        "Percent below: ",
        round(pct_below, 1),
        "%\n",
        "Min coverage: ",
        round(min_cvg, 0),
        "\n",
        "Median coverage: ",
        round(median_cvg, 0)
      ),
      hovertemplate = "<b>%{x}</b><br>Exons below threshold: %{y}<br>%{text}<extra></extra>",
      customdata = ~ cbind(pct_below, min_cvg, median_cvg)
    )
}
steps <- list()
for (i in seq_along(thresholds)) {
  step <- list(
    method = "update",
    args = list(
      list(visible = rep(FALSE, length(thresholds))),
      list(title = paste0("Genes with Exons Below Coverage Threshold = ", thresholds[i]))
    ),
    label = as.character(thresholds[i])
  )
  step$args[[1]]$visible[i] <- TRUE
  steps[[i]] <- step
}

bar_fig <- bar_fig |>
  plotly::layout(
    title = "Genes with Exons Below Coverage Threshold = 20",
    xaxis = list(
      title = "Gene",
      tickangle = -45
    ),
    yaxis = list(title = "Number of Exons Below Threshold"),
    sliders = list(
      list(
        active = 2, # Start at threshold = 20 (index 2)
        currentvalue = list(prefix = "Coverage Threshold: "),
        pad = list(t = 60),
        steps = steps
      )
    ),
    hovermode = "closest",
    margin = list(b = 100)
  )

print(bar_fig)
```

::: {.callout-tip}
## TODO

:::
